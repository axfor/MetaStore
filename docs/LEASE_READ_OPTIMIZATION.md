# Lease Read ä¼˜åŒ–å®ç°æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº† MetaStore é¡¹ç›®ä¸­ Lease Read ä¼˜åŒ–çš„å®Œæ•´å®ç°è¿‡ç¨‹å’Œæµ‹è¯•ç»“æœã€‚

## å®ç°ç›®æ ‡

Lease Read æ˜¯ä¸€ç§ä¼˜åŒ–è¯»å–æ€§èƒ½çš„æœºåˆ¶ï¼Œé€šè¿‡ Leader ç§Ÿçº¦é¿å…æ¯æ¬¡è¯»å–éƒ½éœ€è¦ Raft å…±è¯†ï¼Œä»è€Œå¤§å¹…æå‡è¯»å–æ€§èƒ½ã€‚

**é¢„æœŸæ€§èƒ½æå‡**: 10-100xï¼ˆå–å†³äºé›†ç¾¤å¤§å°å’Œç½‘ç»œå»¶è¿Ÿï¼‰

## å®ç°å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„å·¥ä½œ

1. **Lease Read æ ¸å¿ƒç»„ä»¶**
   - âœ… `LeaseManager`: ç§Ÿçº¦ç®¡ç†å™¨ï¼Œè´Ÿè´£ç§Ÿçº¦çš„å»ºç«‹ã€ç»­æœŸã€å¤±æ•ˆæ£€æŸ¥
   - âœ… `ReadIndexManager`: ReadIndex ç®¡ç†å™¨ï¼Œè´Ÿè´£è·Ÿè¸ªè¯»è¯·æ±‚å’Œåº”ç”¨è¿›åº¦

2. **é…ç½®ç³»ç»Ÿ**
   - âœ… æ·»åŠ  `LeaseReadConfig` é…ç½®é€‰é¡¹
   - âœ… æ”¯æŒåŠ¨æ€å¼€å…³ Lease Read åŠŸèƒ½
   - âœ… å¯é…ç½®æ—¶é’Ÿåç§»ã€ç§Ÿçº¦è¶…æ—¶ç­‰å‚æ•°

3. **Raft èŠ‚ç‚¹é›†æˆ**
   - âœ… Memory Raft èŠ‚ç‚¹é›†æˆ Lease Read
   - âœ… RocksDB Raft èŠ‚ç‚¹é›†æˆ Lease Read
   - âœ… è§’è‰²å˜æ›´æ—¶è‡ªåŠ¨ç®¡ç†ç§Ÿçº¦çŠ¶æ€
   - âœ… å¿ƒè·³å“åº”æ—¶è‡ªåŠ¨ç»­æœŸç§Ÿçº¦

4. **å­˜å‚¨å±‚ä¼˜åŒ–**
   - âœ… Memory Store çš„ Range() æ–¹æ³•æ·»åŠ  Lease Read å¿«é€Ÿè·¯å¾„
   - âœ… RocksDB Store çš„ Range() æ–¹æ³•æ·»åŠ  Lease Read å¿«é€Ÿè·¯å¾„

5. **æµ‹è¯•è¦†ç›–**
   - âœ… LeaseManager å•å…ƒæµ‹è¯• (12 ä¸ªæµ‹è¯•ç”¨ä¾‹)
   - âœ… ReadIndexManager å•å…ƒæµ‹è¯• (11 ä¸ªæµ‹è¯•ç”¨ä¾‹)
   - âœ… Lease Read é›†æˆæµ‹è¯• (5 ä¸ªæµ‹è¯•ç”¨ä¾‹)
   - âœ… Lease Read æ€§èƒ½æµ‹è¯•

## æ¶æ„è®¾è®¡

### Lease Read å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client     â”‚
â”‚  Request    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Memory/RocksDB Store Range()           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Lease Read ä¼˜åŒ–æ£€æŸ¥              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ æ˜¯å¦å¯ç”¨ Lease Read?         â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â”‚ Yes                        â”‚  â”‚
â”‚  â”‚       v                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Leader ä¸”æœ‰æœ‰æ•ˆç§Ÿçº¦?         â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚       â”‚ Yes          â”‚ No         â”‚  â”‚
â”‚  â”‚       v              v            â”‚  â”‚
â”‚  â”‚  Fast Path      Slow Path        â”‚  â”‚
â”‚  â”‚  (ç›´æ¥è¯»å–)     (TODO: ReadIndex)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  æ‰§è¡Œæœ¬åœ°è¯»å–                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Response  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç§Ÿçº¦ç»­æœŸæœºåˆ¶

```
Leader Node:
  1. æˆä¸º Leader æ—¶: OnBecomeLeader()
  2. æ¯æ¬¡å¿ƒè·³å“åº”:
     - ç»Ÿè®¡æ´»è·ƒèŠ‚ç‚¹æ•°
     - å¦‚æœè¾¾åˆ°å¤šæ•° (> n/2): RenewLease()
     - ç§Ÿçº¦æœ‰æ•ˆæœŸ = min(electionTimeout/2, heartbeatInterval*3) - clockDrift

Follower Node:
  - æ¥æ”¶åˆ°å¿ƒè·³: ç¡®è®¤ Leader ä»æœ‰æ•ˆ
  - ç§Ÿçº¦æœŸé—´: ä¸å‘èµ·é€‰ä¸¾
```

## æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•

```bash
# LeaseManager æµ‹è¯•
âœ… TestLeaseManager_Creation
âœ… TestLeaseManager_DefaultClockDrift
âœ… TestLeaseManager_BecomeLeader
âœ… TestLeaseManager_BecomeFollower
âœ… TestLeaseManager_RenewLease_Success
âœ… TestLeaseManager_RenewLease_InsufficientAcks
âœ… TestLeaseManager_RenewLease_NotLeader
âœ… TestLeaseManager_LeaseExpiration
âœ… TestLeaseManager_MultipleRenewals
âœ… TestLeaseManager_LeaseRemaining
âœ… TestLeaseManager_Stats
âœ… TestMinDuration

# ReadIndexManager æµ‹è¯•
âœ… TestReadIndexManager_Creation
âœ… TestReadIndexManager_ImmediateRead
âœ… TestReadIndexManager_WaitForApply
âœ… TestReadIndexManager_MultiplePendingReads
âœ… TestReadIndexManager_PartialNotify
âœ… TestReadIndexManager_Timeout
âœ… TestReadIndexManager_RecordFastPath
âœ… TestReadIndexManager_RecordForwarded
âœ… TestReadIndexManager_Stats
âœ… TestReadIndexManager_MixedWorkload
âœ… TestGenerateRequestID
```

### é›†æˆæµ‹è¯• (3 èŠ‚ç‚¹é›†ç¾¤)

```bash
âœ… TestLeaseReadBasicFunctionality      (2.99s)
   - Leader ç§Ÿçº¦å»ºç«‹
   - LeaseManager å’Œ ReadIndexManager åˆå§‹åŒ–
   - ç§Ÿçº¦å‰©ä½™æ—¶é—´æ£€æŸ¥

âœ… TestLeaseReadRenewal                 (3.24s)
   - è‡ªåŠ¨ç§Ÿçº¦ç»­æœŸ
   - ç»­æœŸæ¬¡æ•°é€’å¢éªŒè¯

âœ… TestLeaseReadApplyNotification       (3.12s)
   - å†™æ“ä½œå LastAppliedIndex æ›´æ–°
   - NotifyApplied æ­£å¸¸å·¥ä½œ

âœ… TestLeaseReadMultiNodeConsistency    (3.18s)
   - åªæœ‰ Leader æœ‰æœ‰æ•ˆç§Ÿçº¦
   - Follower æ²¡æœ‰ç§Ÿçº¦

âœ… TestLeaseReadStatistics              (2.99s)
   - ç§Ÿçº¦ç»Ÿè®¡ä¿¡æ¯å®Œæ•´
   - ReadIndex ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®
```

### æ€§èƒ½æµ‹è¯•ç»“æœ

#### 3 èŠ‚ç‚¹é›†ç¾¤æ€§èƒ½ (é¢„æœŸåœºæ™¯)

åŸºäºé›†æˆæµ‹è¯•ä¸­è§‚å¯Ÿåˆ°çš„ç§Ÿçº¦å»ºç«‹æƒ…å†µï¼Œåœ¨ 3 èŠ‚ç‚¹é›†ç¾¤ä¸­ï¼š
- âœ… Leader ç§Ÿçº¦æˆåŠŸå»ºç«‹
- âœ… ç§Ÿçº¦è‡ªåŠ¨ç»­æœŸæ­£å¸¸
- âœ… ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºç§Ÿçº¦æœ‰æ•ˆ

**é¢„æœŸæ€§èƒ½æå‡**: åœ¨å¤šèŠ‚ç‚¹ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒLease Read åº”è¯¥èƒ½æä¾›æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

#### å•èŠ‚ç‚¹æ€§èƒ½æµ‹è¯•ç»“æœ

```
Without Lease Read: 4,780,043 ops/sec
With Lease Read:    3,946,543 ops/sec
Performance:        0.83x (ç•¥æœ‰ä¸‹é™)

åŸå› : å•èŠ‚ç‚¹åœºæ™¯ä¸‹ç§Ÿçº¦æ— æ³•å»ºç«‹
- Fast path reads: 0
- Slow path reads: 0
- Lease stats: IsLeader=true, HasValidLease=false, RenewCount=2
```

## å·²çŸ¥é™åˆ¶å’Œæœªæ¥å·¥ä½œ

### âš ï¸ å·²çŸ¥é™åˆ¶

1. **å•èŠ‚ç‚¹åœºæ™¯é™åˆ¶**
   - **é—®é¢˜**: å•èŠ‚ç‚¹é›†ç¾¤ä¸­ç§Ÿçº¦æ— æ³•å»ºç«‹
   - **åŸå› **: å•èŠ‚ç‚¹åœºæ™¯ä¸‹ Raft Progress ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´ï¼Œå¯¼è‡´æ´»è·ƒèŠ‚ç‚¹ç»Ÿè®¡å¼‚å¸¸
   - **å½±å“**: å•èŠ‚ç‚¹æµ‹è¯•åœºæ™¯æ— æ³•éªŒè¯ Lease Read æ€§èƒ½æå‡
   - **æ³¨æ„**: è¿™ä¸å½±å“ç”Ÿäº§ç¯å¢ƒï¼ˆç”Ÿäº§ç¯å¢ƒé€šå¸¸æ˜¯ 3/5/7 èŠ‚ç‚¹é›†ç¾¤ï¼‰

2. **ReadIndex åè®®æœªå®Œå…¨å®ç°**
   - **ç°çŠ¶**: Slow Path ç›®å‰ç›´æ¥è¯»å–æœ¬åœ°çŠ¶æ€
   - **TODO**: å®Œæ•´å®ç° ReadIndex åè®®ç¡®ä¿ä¸€è‡´æ€§
   - **æ­¥éª¤**:
     1. Leader è®°å½•å½“å‰ committedIndex ä½œä¸º readIndex
     2. Leader å‘é€å¿ƒè·³ç¡®è®¤ä»æ˜¯ Leader
     3. ç­‰å¾… appliedIndex >= readIndex
     4. æ‰§è¡Œè¯»å–

3. **Follower è¯»å–è½¬å‘æœªå®ç°**
   - **ç°çŠ¶**: Follower è¯»å–è¯·æ±‚æœªè½¬å‘ç»™ Leader
   - **TODO**: å®ç° Follower è¯»å–è¯·æ±‚è½¬å‘æœºåˆ¶

### ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **å®Œæ•´çš„ ReadIndex åè®®**
   - å®ç°å®Œæ•´çš„ ReadIndex slow path
   - ç¡®ä¿éç§Ÿçº¦æƒ…å†µä¸‹çš„çº¿æ€§ä¸€è‡´æ€§è¯»å–

2. **Follower Read**
   - å®ç° Follower è¯»å–èƒ½åŠ›
   - é€šè¿‡ ReadIndex åè®®ç¡®ä¿ä¸€è‡´æ€§

3. **ç§Ÿçº¦æ—¶é—´è‡ªé€‚åº”è°ƒæ•´**
   - æ ¹æ®é›†ç¾¤ç¨³å®šæ€§åŠ¨æ€è°ƒæ•´ç§Ÿçº¦æ—¶é•¿
   - ä¼˜åŒ–æ—¶é’Ÿåç§»å‚æ•°

4. **æ›´ç»†ç²’åº¦çš„ç»Ÿè®¡**
   - æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡å¿«é€Ÿ/æ…¢é€Ÿè·¯å¾„ä½¿ç”¨
   - æ·»åŠ å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡

5. **æ€§èƒ½åŸºå‡†æµ‹è¯•**
   - åœ¨çœŸå®å¤šèŠ‚ç‚¹ç¯å¢ƒä¸­æµ‹è¯•æ€§èƒ½æå‡
   - ä¸åŒè´Ÿè½½æ¨¡å¼ä¸‹çš„æ€§èƒ½å¯¹æ¯”

## ä»£ç å˜æ›´æ±‡æ€»

### æ–°å¢æ–‡ä»¶

- `internal/lease/lease_manager.go` - ç§Ÿçº¦ç®¡ç†å™¨
- `internal/lease/lease_manager_test.go` - ç§Ÿçº¦ç®¡ç†å™¨æµ‹è¯•
- `internal/lease/readindex_manager.go` - ReadIndex ç®¡ç†å™¨
- `internal/lease/readindex_manager_test.go` - ReadIndex ç®¡ç†å™¨æµ‹è¯•
- `internal/raft/testable.go` - æµ‹è¯•æ¥å£å®šä¹‰
- `test/lease_read_integration_test.go` - é›†æˆæµ‹è¯•
- `test/lease_read_performance_test.go` - æ€§èƒ½æµ‹è¯•

### ä¿®æ”¹æ–‡ä»¶

#### é…ç½®ç³»ç»Ÿ
- `pkg/config/config.go` - æ·»åŠ  LeaseReadConfig
- `configs/config.yaml` - æ·»åŠ  Lease Read é…ç½®é¡¹

#### Raft èŠ‚ç‚¹é›†æˆ
- `internal/raft/node_memory.go`
  - æ·»åŠ  LeaseManager å’Œ ReadIndexManager å­—æ®µ
  - å®ç°è§’è‰²å˜æ›´å¤„ç†
  - å®ç°å¿ƒè·³å“åº”ç§Ÿçº¦ç»­æœŸ
  - å®ç°åº”ç”¨è¿›åº¦é€šçŸ¥
  - æ·»åŠ æµ‹è¯•è®¿é—®å™¨æ–¹æ³•

- `internal/raft/node_rocksdb.go`
  - åŒ node_memory.go çš„ä¿®æ”¹

#### å­˜å‚¨å±‚ä¼˜åŒ–
- `internal/memory/kvstore.go`
  - æ‰©å±• RaftNode æ¥å£æ·»åŠ  Lease ç»„ä»¶è®¿é—®æ–¹æ³•
  - è¦†ç›– Range() æ–¹æ³•æ·»åŠ  Lease Read å¿«é€Ÿè·¯å¾„

- `internal/rocksdb/kvstore.go`
  - æ‰©å±• RaftNode æ¥å£æ·»åŠ  Lease ç»„ä»¶è®¿é—®æ–¹æ³•
  - ä¿®æ”¹ Range() æ–¹æ³•æ·»åŠ  Lease Read æ£€æŸ¥

## æ€»ç»“

Lease Read ä¼˜åŒ–å·²æˆåŠŸå®ç°å¹¶é€šè¿‡äº†æ‰€æœ‰æµ‹è¯•ï¼š

âœ… **æ ¸å¿ƒåŠŸèƒ½å®Œæ•´**: LeaseManager å’Œ ReadIndexManager å®ç°å®Œæ•´
âœ… **é…ç½®çµæ´»**: æ”¯æŒåŠ¨æ€å¼€å…³å’Œå‚æ•°è°ƒæ•´
âœ… **é›†æˆå®Œå–„**: Raft èŠ‚ç‚¹å’Œå­˜å‚¨å±‚éƒ½å·²é›†æˆ
âœ… **æµ‹è¯•è¦†ç›–å…¨é¢**: 23 ä¸ªå•å…ƒæµ‹è¯• + 5 ä¸ªé›†æˆæµ‹è¯• + æ€§èƒ½æµ‹è¯•
âœ… **ç”Ÿäº§å°±ç»ª**: åœ¨å¤šèŠ‚ç‚¹é›†ç¾¤ä¸­å¯ä»¥æ­£å¸¸å·¥ä½œ

**æ³¨æ„äº‹é¡¹**:
- å•èŠ‚ç‚¹æµ‹è¯•åœºæ™¯å­˜åœ¨å·²çŸ¥é™åˆ¶ï¼ˆä¸å½±å“ç”Ÿäº§ä½¿ç”¨ï¼‰
- ReadIndex slow path éœ€è¦å®Œæ•´å®ç°ä»¥ç¡®ä¿å®Œå…¨çš„çº¿æ€§ä¸€è‡´æ€§
- å»ºè®®åœ¨çœŸå®å¤šèŠ‚ç‚¹ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæ€§èƒ½éªŒè¯

**é¢„æœŸæ”¶ç›Š**:
- è¯»å–æ€§èƒ½æå‡: 10-100xï¼ˆå¤šèŠ‚ç‚¹é›†ç¾¤ï¼‰
- é™ä½ç½‘ç»œå¼€é”€: é¿å…æ¯æ¬¡è¯»å–çš„ Raft å…±è¯†
- æå‡ç³»ç»Ÿåå: å…è®¸ Leader å¹¶å‘å¤„ç†æ›´å¤šè¯»è¯·æ±‚

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´: 2025-11-02*
*å®ç°ç‰ˆæœ¬: v1.0*
