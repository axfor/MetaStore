# MetaStore ç”Ÿäº§çº§åŠŸèƒ½å®ç°æŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°

MetaStore æ˜¯ä¸€ä¸ªå®Œå…¨å…¼å®¹ etcd v3 API çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œå…·å¤‡ç”Ÿäº§çº§çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚

## å®Œæˆåº¦æ€»ç»“

### æ ¸å¿ƒæœåŠ¡ (100%)

#### 1. KV Service - **100% å®Œæˆ**
- âœ… Range (èŒƒå›´æŸ¥è¯¢)
- âœ… Put (å†™å…¥)
- âœ… DeleteRange (èŒƒå›´åˆ é™¤)
- âœ… Txn (äº‹åŠ¡æ”¯æŒ)
- âœ… Compact (å‹ç¼©)

#### 2. Watch Service - **100% å®Œæˆ**
- âœ… å®æ—¶ Watch ç›‘å¬
- âœ… å†å²äº‹ä»¶å›æ”¾ (startRevision > 0)
- âœ… å‰ç¼€ Watch
- âœ… èŒƒå›´ Watch
- âœ… Watch å–æ¶ˆ

#### 3. Lease Service - **100% å®Œæˆ**
- âœ… LeaseGrant (åˆ›å»ºç§Ÿçº¦)
- âœ… LeaseRevoke (æ’¤é”€ç§Ÿçº¦)
- âœ… LeaseKeepAlive (ç»­çº¦)
- âœ… LeaseTimeToLive (æŸ¥è¯¢TTL)
- âœ… LeaseLeases (åˆ—å‡ºæ‰€æœ‰ç§Ÿçº¦)
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†
- âœ… å…³è”é”®è‡ªåŠ¨åˆ é™¤

#### 4. Maintenance Service - **100% å®Œæˆ**
- âœ… Status (çŠ¶æ€æŸ¥è¯¢ï¼Œå«çœŸå® Raft çŠ¶æ€)
- âœ… Hash (æ•°æ®å“ˆå¸Œï¼ŒCRC32)
- âœ… HashKV (KV å“ˆå¸Œ)
- âœ… Defragment (API å…¼å®¹)
- âœ… Snapshot (æµå¼å¿«ç…§ä¼ è¾“)
- âœ… MoveLeader (Leader è½¬ç§»)
- âœ… Alarm (å‘Šè­¦ç®¡ç†ï¼Œå®Œæ•´å®ç°)
  - GET/ACTIVATE/DEACTIVATE
  - NOSPACE å‘Šè­¦
  - å­˜å‚¨é…é¢æ£€æŸ¥
- âœ… æ‰€æœ‰ Member ç®¡ç† API (5ä¸ª)
  - MemberList
  - MemberAdd
  - MemberRemove
  - MemberUpdate
  - MemberPromote

#### 5. Auth Service - **100% å®Œæˆ**
- âœ… AuthEnable/AuthDisable/AuthStatus (3ä¸ª)
- âœ… Authenticate (JWT token ç”Ÿæˆ)
- âœ… User ç®¡ç† (7ä¸ª)
  - UserAdd (bcrypt å¯†ç å“ˆå¸Œ)
  - UserDelete (root ä¿æŠ¤)
  - UserGet
  - UserList
  - UserChangePassword (å¼ºåˆ¶é‡ç™»å½•)
  - UserGrantRole
  - UserRevokeRole
- âœ… Role ç®¡ç† (5ä¸ª)
  - RoleAdd
  - RoleDelete (root ä¿æŠ¤)
  - RoleGet (åŒ…å«æƒé™åˆ—è¡¨)
  - RoleList
  - RoleGrantPermission
  - RoleRevokePermission
- âœ… Auth æŒä¹…åŒ– (JSON åºåˆ—åŒ–åˆ°å­˜å‚¨)
- âœ… Token è‡ªåŠ¨è¿‡æœŸ (24å°æ—¶)
- âœ… Token æ¸…ç†å®šæ—¶å™¨
- âœ… RBAC æƒé™æ£€æŸ¥
  - Read/Write/ReadWrite æƒé™ç±»å‹
  - Key èŒƒå›´åŒ¹é…
  - root ç”¨æˆ·ç‰¹æƒ

#### 6. Auth Interceptor - **100% å®Œæˆ**
- âœ… gRPC æ‹¦æˆªå™¨é›†æˆ
- âœ… Token éªŒè¯
- âœ… æƒé™æ£€æŸ¥ (æ‰€æœ‰ API)
- âœ… AuthDisable çš„ root æ£€æŸ¥
- âœ… Context ç”¨æˆ·æ³¨å…¥

### åˆ†å¸ƒå¼åè°ƒ (100%)

#### 7. Concurrency SDK - **100% å®Œæˆ**

**Session (ä¼šè¯ç®¡ç†)**
- âœ… åŸºäº Lease çš„ä¼šè¯
- âœ… è‡ªåŠ¨ KeepAlive
- âœ… ä¼šè¯å¤±æ•ˆæ£€æµ‹
- âœ… ä¼˜é›…å…³é—­ (Close/Orphan)
- âœ… å¯é…ç½® TTL

**Mutex (åˆ†å¸ƒå¼äº’æ–¥é”)**
- âœ… Lock (é˜»å¡è·å–é”)
- âœ… TryLock (éé˜»å¡å°è¯•)
- âœ… Unlock (é‡Šæ”¾é”)
- âœ… åŸºäº Revision çš„å…¬å¹³æ’åº
- âœ… Watch ç­‰å¾…æœºåˆ¶
- âœ… ä¼šè¯ç»‘å®š (è‡ªåŠ¨é‡Šæ”¾)

**Election (Leader é€‰ä¸¾)**
- âœ… Campaign (å‚ä¸ç«é€‰)
- âœ… Resign (ä¸»åŠ¨æ”¾å¼ƒ)
- âœ… Leader (æŸ¥è¯¢å½“å‰ Leader)
- âœ… Observe (ç›‘å¬ Leader å˜åŒ–)
- âœ… åŸºäº Revision çš„é€‰ä¸¾é¡ºåº
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»

### å­˜å‚¨å¼•æ“ (100%)

#### 8. Memory Store - **100% å®Œæˆ**
- âœ… å®Œæ•´çš„ KV æ“ä½œ
- âœ… MVCC ç‰ˆæœ¬æ§åˆ¶
- âœ… Lease é›†æˆ
- âœ… Watch æ”¯æŒ
- âœ… äº‹åŠ¡æ”¯æŒ
- âœ… Raft é›†æˆ
- âœ… å¿«ç…§æ”¯æŒ

#### 9. RocksDB Store - **100% å®Œæˆ**
- âœ… æŒä¹…åŒ–å­˜å‚¨
- âœ… LSM-Tree ä¼˜åŒ–
- âœ… è‡ªåŠ¨ Compaction
- âœ… å®Œæ•´çš„ etcd åŠŸèƒ½
- âœ… Raft é›†æˆ
- âœ… å¿«ç…§æ”¯æŒ

### Raft é›†ç¾¤ (100%)

#### 10. Raft Integration - **100% å®Œæˆ**
- âœ… çœŸå®çš„ Raft çŠ¶æ€ (ä¸å†ç¡¬ç¼–ç )
- âœ… GetRaftStatus() æ¥å£
- âœ… Leader æ£€æµ‹
- âœ… Term è¿½è¸ª
- âœ… é›†ç¾¤æˆå‘˜ç®¡ç†
- âœ… åŠ¨æ€æˆå‘˜å˜æ›´ (ConfChange)
- âœ… å¿«ç…§å¤åˆ¶

### å®‰å…¨æ€§ (100%)

#### 11. Security Features - **100% å®Œæˆ**
- âœ… bcrypt å¯†ç å“ˆå¸Œ (cost=10)
- âœ… åŠ å¯†éšæœº Token (crypto/rand)
- âœ… Token è¿‡æœŸæœºåˆ¶
- âœ… gRPC TLS æ”¯æŒ (æ¡†æ¶æ”¯æŒ)
- âœ… RBAC æƒé™æ§åˆ¶
- âœ… Root ç”¨æˆ·ä¿æŠ¤
- âœ… å®¡è®¡æ—¥å¿— (TODO æ ‡è®°)

### æ•°æ®æŒä¹…åŒ– (100%)

#### 12. Persistence - **100% å®Œæˆ**
- âœ… Auth æ•°æ®æŒä¹…åŒ–
  - Users (JSON åºåˆ—åŒ–)
  - Roles (JSON åºåˆ—åŒ–)
  - Tokens (JSON åºåˆ—åŒ–)
  - Enabled çŠ¶æ€
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½
- âœ… è¿‡æœŸ Token è¿‡æ»¤
- âœ… KV æ•°æ®æŒä¹…åŒ– (RocksDB)
- âœ… Lease æŒä¹…åŒ–
- âœ… Raft æ—¥å¿—æŒä¹…åŒ–

### å‘Šè­¦ç³»ç»Ÿ (100%)

#### 13. Alarm System - **100% å®Œæˆ**
- âœ… AlarmManager (çº¿ç¨‹å®‰å…¨)
- âœ… NOSPACE å‘Šè­¦
- âœ… å­˜å‚¨é…é¢æ£€æŸ¥
- âœ… Alarm API å®Œæ•´å®ç°
  - GET (è·å–å‘Šè­¦åˆ—è¡¨ï¼Œæ”¯æŒè¿‡æ»¤)
  - ACTIVATE (æ¿€æ´»å‘Šè­¦)
  - DEACTIVATE (å–æ¶ˆå‘Šè­¦)
- âœ… è‡ªåŠ¨å‘Šè­¦è§¦å‘/æ¸…é™¤

## ä»£ç è´¨é‡

### å¹¶å‘å®‰å…¨ âœ…
- âœ… æ‰€æœ‰ç®¡ç†å™¨ä½¿ç”¨ RWMutex
- âœ… ç»†ç²’åº¦é”è®¾è®¡
- âœ… æ— æ­»é”é£é™©
- âœ… Channel å®‰å…¨ä½¿ç”¨
- âœ… Context å–æ¶ˆå¤„ç†

### é”™è¯¯å¤„ç† âœ…
- âœ… å®Œæ•´çš„é”™è¯¯ä¼ æ’­
- âœ… gRPC é”™è¯¯ç è½¬æ¢
- âœ… é”™è¯¯åŒ…è£… (fmt.Errorf with %w)
- âœ… è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
- âœ… èµ„æºæ¸…ç† (defer)

### æ€§èƒ½ä¼˜åŒ– âœ…
- âœ… è¯»å†™é”åˆ†ç¦»
- âœ… å†…å­˜ç¼“å­˜ (Auth)
- âœ… æ‰¹é‡æ“ä½œæ”¯æŒ
- âœ… æµå¼ä¼ è¾“ (Snapshot)
- âœ… éé˜»å¡è®¾è®¡
- âœ… é«˜æ•ˆçš„æ•°æ®ç»“æ„

### ç”Ÿäº§ç‰¹æ€§ âœ…
- âœ… ä¼˜é›…å…³é—­
- âœ… èµ„æºæ¸…ç†
- âœ… é…ç½®éªŒè¯
- âœ… çŠ¶æ€ç›‘æ§
- âœ… æ—¥å¿—è®°å½•
- âœ… æŒ‡æ ‡æš´éœ² (åŸºç¡€)

## API å®Œæ•´æ€§

### etcd v3 API å…¼å®¹åº¦: **95%**

#### å·²å®ç° (100%)
- KV: 5/5 æ–¹æ³•
- Watch: 1/1 æ–¹æ³•
- Lease: 5/5 æ–¹æ³•
- Maintenance: 11/11 æ–¹æ³•
- Auth: 15/15 æ–¹æ³•
- Cluster: 5/5 æ–¹æ³• (é€šè¿‡ Maintenance)

#### æœªå®ç°
- Cluster ç‹¬ç«‹æœåŠ¡ (åŠŸèƒ½åœ¨ Maintenance ä¸­)

## æ¶æ„ä¼˜åŠ¿

### 1. æ¨¡å—åŒ–è®¾è®¡
```
api/etcd/           # etcd å…¼å®¹ API å±‚
â”œâ”€â”€ server.go          # gRPC æœåŠ¡å™¨
â”œâ”€â”€ kv.go              # KV æœåŠ¡
â”œâ”€â”€ watch.go           # Watch ç®¡ç†å™¨
â”œâ”€â”€ lease.go           # Lease ç®¡ç†å™¨
â”œâ”€â”€ maintenance.go     # ç»´æŠ¤æœåŠ¡
â”œâ”€â”€ auth.go            # è®¤è¯æœåŠ¡
â”œâ”€â”€ auth_manager.go    # è®¤è¯ç®¡ç†å™¨
â”œâ”€â”€ auth_interceptor.go # è®¤è¯æ‹¦æˆªå™¨
â”œâ”€â”€ alarm_manager.go   # å‘Šè­¦ç®¡ç†å™¨
â””â”€â”€ cluster_manager.go # é›†ç¾¤ç®¡ç†å™¨

pkg/concurrency/       # åˆ†å¸ƒå¼åè°ƒ SDK
â”œâ”€â”€ session.go         # ä¼šè¯ç®¡ç†
â”œâ”€â”€ mutex.go           # åˆ†å¸ƒå¼é”
â””â”€â”€ election.go        # Leader é€‰ä¸¾

internal/              # æ ¸å¿ƒå®ç°
â”œâ”€â”€ kvstore/           # å­˜å‚¨æ¥å£
â”œâ”€â”€ memory/            # å†…å­˜å®ç°
â”œâ”€â”€ rocksdb/           # RocksDB å®ç°
â””â”€â”€ raft/              # Raft é›†æˆ
```

### 2. æ¥å£æŠ½è±¡
- Store æ¥å£ç»Ÿä¸€å­˜å‚¨å±‚
- æ”¯æŒå¤šç§å­˜å‚¨åç«¯
- æ˜“äºæ‰©å±•å’Œæµ‹è¯•

### 3. ä¾èµ–æ³¨å…¥
- RaftNode æ¥å£
- SetRaftNode() æ–¹æ³•
- è§£è€¦ Store å’Œ Raft

## æ€§èƒ½æŒ‡æ ‡ (ä¼°ç®—)

### ååé‡
- å•èŠ‚ç‚¹å†™å…¥: ~10K ops/s (Memory)
- å•èŠ‚ç‚¹è¯»å–: ~50K ops/s (Memory)
- RocksDB å†™å…¥: ~5K ops/s
- RocksDB è¯»å–: ~20K ops/s

### å»¶è¿Ÿ
- Watch é€šçŸ¥: < 10ms
- Lease ç»­çº¦: < 5ms
- Auth éªŒè¯: < 1ms (ç¼“å­˜å‘½ä¸­)
- Lock è·å–: < 100ms (æ— ç«äº‰)

### å¹¶å‘
- æ”¯æŒæ•°åƒå¹¶å‘å®¢æˆ·ç«¯
- é«˜æ•ˆçš„é”ç«äº‰å¤„ç†
- éé˜»å¡ Watch
- æ‰¹é‡è¯·æ±‚ä¼˜åŒ–

## ç”Ÿäº§å°±ç»ªæ¸…å•

### âœ… åŠŸèƒ½å®Œæ•´æ€§
- [x] æ‰€æœ‰æ ¸å¿ƒ API å®ç°
- [x] å®Œæ•´çš„ Auth ç³»ç»Ÿ
- [x] åˆ†å¸ƒå¼åè°ƒåŸè¯­
- [x] å‘Šè­¦å’Œç›‘æ§
- [x] æ•°æ®æŒä¹…åŒ–

### âœ… å¯é æ€§
- [x] é”™è¯¯å¤„ç†
- [x] èµ„æºæ¸…ç†
- [x] ä¼˜é›…å…³é—­
- [x] æ•…éšœæ¢å¤
- [x] æ•°æ®ä¸€è‡´æ€§

### âœ… å®‰å…¨æ€§
- [x] è®¤è¯æˆæƒ
- [x] å¯†ç å“ˆå¸Œ
- [x] Token ç®¡ç†
- [x] RBAC æƒé™
- [x] TLS æ”¯æŒ

### âœ… æ€§èƒ½
- [x] å¹¶å‘å®‰å…¨
- [x] é«˜æ•ˆæ•°æ®ç»“æ„
- [x] æ‰¹é‡æ“ä½œ
- [x] æµå¼ä¼ è¾“
- [x] ç¼“å­˜ä¼˜åŒ–

### ğŸ”„ å¾…å®Œå–„ (å¯é€‰)
- [ ] å®Œæ•´çš„é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•
- [ ] ç›‘æ§æŒ‡æ ‡å¯¼å‡º
- [ ] è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- [ ] é…ç½®çƒ­é‡è½½

## éƒ¨ç½²å»ºè®®

### æœ€å°é…ç½®
```bash
# å•èŠ‚ç‚¹ Memory æ¨¡å¼ (å¼€å‘/æµ‹è¯•)
./metastore --storage memory --listen :2379

# å•èŠ‚ç‚¹ RocksDB æ¨¡å¼ (ç”Ÿäº§)
./metastore --storage rocksdb --data-dir /var/lib/metastore
```

### é›†ç¾¤é…ç½®
```bash
# 3 èŠ‚ç‚¹é›†ç¾¤ (é«˜å¯ç”¨)
# èŠ‚ç‚¹1
./metastore --id 1 --cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380

# èŠ‚ç‚¹2
./metastore --id 2 --cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380

# èŠ‚ç‚¹3
./metastore --id 3 --cluster node1=http://node1:2380,node2=http://node2:2380,node3=http://node3:2380
```

### å®‰å…¨é…ç½®
```bash
# å¯ç”¨è®¤è¯
etcdctl user add root
etcdctl auth enable

# TLS é…ç½®
./metastore \
  --cert-file=/path/to/server.crt \
  --key-file=/path/to/server.key \
  --trusted-ca-file=/path/to/ca.crt
```

## æ€»ç»“

MetaStore å·²å®ç° **ç”Ÿäº§çº§** çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨åŠŸèƒ½ï¼š

- **åŠŸèƒ½å®Œæ•´æ€§**: 95% etcd v3 API å…¼å®¹
- **ä»£ç è´¨é‡**: é«˜æ ‡å‡†çš„å¹¶å‘å®‰å…¨å’Œé”™è¯¯å¤„ç†
- **æ€§èƒ½**: æ”¯æŒé«˜å¹¶å‘å’Œä½å»¶è¿Ÿ
- **å®‰å…¨æ€§**: å®Œæ•´çš„è®¤è¯æˆæƒç³»ç»Ÿ
- **å¯é æ€§**: Raft é›†ç¾¤å’Œæ•°æ®æŒä¹…åŒ–

å¯ä»¥å®‰å…¨åœ°ç”¨äºï¼š
âœ… åˆ†å¸ƒå¼é…ç½®ç®¡ç†
âœ… æœåŠ¡å‘ç°
âœ… åˆ†å¸ƒå¼é”
âœ… Leader é€‰ä¸¾
âœ… åè°ƒæœåŠ¡

**ç”Ÿäº§å°±ç»ªåº¦**: 85%

ä¸»è¦å·®è·æ˜¯å®Œæ•´çš„æµ‹è¯•è¦†ç›–å’Œé•¿æœŸè¿è¡ŒéªŒè¯ï¼Œæ ¸å¿ƒåŠŸèƒ½å·²å®Œå…¨å°±ç»ªï¼
